<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Self-Check</title>
  <meta name="robots" content="noindex,nofollow,noarchive" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; padding: 16px; }
    pre { background: #f6f8fa; padding: 12px; overflow: auto; }
    .ok { color: #0a7c2f; }
    .warn { color: #a15f00; }
    .err { color: #b00020; }
  </style>
</head>
<body>
  <h1>Admin Self-Check</h1>
  <p>This page reports what the admin shell sees at runtime. Use after each deploy.</p>

  <h2>Runtime Diagnostics</h2>
  <ul>
    <li><strong>decapVersion</strong>: <span id="decapVersion">(loading)</span></li>
    <li><strong>initCount</strong>: <span id="initCount">(loading)</span></li>
    <li><strong>yamlFetched</strong>: <span id="yamlFetched">(loading)</span></li>
    <li><strong>collections</strong>: <span id="collections">(loading)</span></li>
  </ul>

  <h2>window.CMS_CONFIG (source of truth)</h2>
  <pre id="cmsConfig">(loading)</pre>

  <h2>Fetch /admin-config/config.yml (should succeed; not used at runtime)</h2>
  <pre id="ymlFetch">(loading)</pre>

  <script>
    (async function () {
      function set(id, val) { document.getElementById(id).textContent = String(val); }
      try {
        // Pull from window.__ADMIN_DIAG__ if available
        var diag = window.__ADMIN_DIAG__ || {};
        set('decapVersion', diag.decapVersion || 'unknown');
        set('initCount', diag.initCount != null ? diag.initCount : 'n/a');
        set('yamlFetched', diag.yamlFetched != null ? diag.yamlFetched : 'n/a');
        set('collections', Array.isArray(diag.collections) ? diag.collections.join(', ') : 'n/a');
      } catch (e) {
        set('decapVersion', 'error');
        set('initCount', 'error');
        set('yamlFetched', 'error');
        set('collections', 'error');
      }

      try {
        var cfg = window.CMS_CONFIG || {};
        document.getElementById('cmsConfig').textContent = JSON.stringify(cfg, null, 2);
      } catch (e) {
        document.getElementById('cmsConfig').textContent = 'Error reading CMS_CONFIG: ' + e.message;
      }

      try {
        var resp = await fetch('/admin-config/config.yml', { cache: 'no-store' });
        var text = await resp.text();
        document.getElementById('ymlFetch').textContent = 'Status: ' + resp.status + '\n---\n' + text.slice(0, 1000);
      } catch (e) {
        document.getElementById('ymlFetch').textContent = 'Error fetching YAML: ' + e.message;
      }
    })();
  </script>
</body>
</html>
